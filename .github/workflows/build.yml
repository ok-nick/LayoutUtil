name: build 
on:
  workflow_dispatch:
  push:
    tags:
      - v*.*.*
    paths:
      - '**.yml'
      - '**.lua'
      - '**.ts'
  pull_request:
    paths:
      - '**.yml'
      - '**.lua'
      - '**.ts'

jobs:
  format_lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install tooling
        uses: ok-nick/setup-aftman@v0
        with:
          trust-check: false

      - name: Format Luau
        run: stylua src plugin test bin -c

      - name: Lint Luau
        run: |
          selene generate-roblox-std
          selene src plugin test bin

      - name: Install Typescript dependencies
        uses: bahmutov/npm-install@v1.8.17

      - name: Lint and format Typescript
        run: npm run eslint

  # run-in-roblox isn't very reliable
  # unit-test:
  #   runs-on: windows-latest
  #   timeout-minutes: 10
  #
  #   steps:
  #     - uses: actions/checkout@v3
  #       with:
  #         submodules: recursive
  #
  #     - name: Install Roblox Studio
  #       uses: OrbitalOwen/roblox-win-installer-action@1.1
  #       with:
  #         cookie: ${{ secrets.ROBLOSECURITY }}
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Install tooling
  #       uses: ok-nick/setup-aftman@v0
  #       with:
  #         trust-check: false
  #
  #     # TODO: have to install packages from wally
  #
  #     - name: Build place file
  #       run: rojo build bin/test.project.json --output bin/test-place.rbxlx
  #
  #     - name: Run unit tests
  #       run: run-in-roblox --place bin/test-place.rbxlx --script bin/run-ci-tests.server.lua

  deploy:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: format_lint
    # needs: [format_lint, unit-test]

    steps:
    - uses: actions/checkout@v3

    - name: Install tooling
      uses: ok-nick/setup-aftman@v0
      with:
        trust-check: false

    - name: Build files
      run: |
        rojo build bin/library.project.json --output bin/LayoutUtil.rbxm
        rojo build bin/plugin.project.json --output bin/LayoutUtil-Plugin.rbxm

    # - name: Upload
    #   run: |
    #     rojo upload bin/library.project.json --asset_id 6723754061 --cookie ${{ secrets.ROBLOSECURITY }}
    #     rojo upload bin/plugin.project.json --asset_id 6723751472 --cookie ${{ secrets.ROBLOSECURITY }}

    - name: Get version
      run: |
        VERSION=`grep -P "version = '(\d\.\d\.\d)'" wally.toml`
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Get description
      run: |
        DESCRIPTION=`grep -m 1 -Po '(###\s(:?.|\s(?!##\s|\[Unreleased\]))+)' CHANGELOG.md`
        echo "$DESCRIPTION" >> $GITHUB_ENV

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.VERSION }}
        tag_name: ${{ env.VERSION }}
        body: ${{ env.DESCRIPTION }}
        files: |
          bin/LayoutUtil.rbxm
          bin/LayoutUtil-Plugin.rbxm
      env:
        GITHUB_TOKEN: ${{ github.token }}
